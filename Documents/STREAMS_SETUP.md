# OpenMHz Streams Integration - Setup Guide

This guide covers Steps 6 and 7 of the OpenMHz integration: exposing stream data to the frontend and creating a user interface for listening to emergency radio streams with blockchain-based rewards.

## Quick Start

**TL;DR - Three terminals (run from project root):**

```bash
# Terminal 1: Start blockchain
yarn chain

# Terminal 2: Start API server
yarn api

# Terminal 3: Start frontend
yarn start
```

Then visit: **http://localhost:3000/streams**

**⚠️ Important:** If you get "Failed to fetch" error, make sure Terminal 2 (API server) is running!

## Overview

The integration consists of:

1. **Backend API Server** - Serves stream data and tracks active listeners
2. **Frontend Streams Page** - Displays streams and provides audio playback
3. **Stream Data** - Generated by `ingest_openmhz.py` with wallet addresses

## Architecture

```
┌─────────────────────┐
│  ingest_openmhz.py  │
│  (generates JSON)   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Assets/             │
│ example_streams_    │
│ with_wallets.json   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  backend/           │
│  apiServer.js       │
│  (Express API)      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  frontend/nextjs/   │
│  app/streams/       │
│  page.tsx           │
└─────────────────────┘
```

## Setup Instructions

### 1. Install All Dependencies

This project uses Yarn workspaces. Install everything from the root:

```bash
# From the project root
yarn install
```

This will install dependencies for both backend and frontend, including:
- `express` - Web server framework
- `cors` - Enable CORS for frontend communication

### 2. Configure Environment Variables

The `.env.local` file has been created in `frontend/nextjs/` with:

```bash
# frontend/nextjs/.env.local
NEXT_PUBLIC_API_URL=http://localhost:3001
```

This tells the frontend where to find the API server.

### 3. Generate Stream Data (Optional)

The example data is already available in `backend/openmhz/example_streams_with_wallets.json`.

To regenerate with fresh data from OpenMHz:

```bash
cd backend/openmhz
python3 ingest_openmhz.py
```

This will update `backend/openmhz/example_streams_with_wallets.json` with the latest stream data.

## Running the System

### Start All Services

You'll need to run three services. **All commands run from the project root directory:**

#### 1. Start the Hardhat Local Blockchain (Terminal 1)

```bash
yarn chain
```

This runs the local Ethereum node on `http://localhost:8545`.

#### 2. Start the API Server (Terminal 2) ⚠️ **CRITICAL**

```bash
yarn api
```

The API server will start on `http://localhost:3001`.

**Important:** Make sure you see the output showing:
```
🚀 Argus Defense API Server running on http://localhost:3001
```

**This is required for the streams page to work!** Without it, you'll get "Failed to fetch" errors.

#### 3. Start the Frontend (Terminal 3)

```bash
yarn start
```

The frontend will start on `http://localhost:3000`.

## API Endpoints

The backend API server provides the following endpoints:

### GET /api/streams
Returns all available streams with metadata and wallet addresses.

**Response:**
```json
{
  "total_streams": 3,
  "last_updated": "2025-10-23T20:15:33.000Z",
  "streams": [
    {
      "stream_id": "rhode-island-3344-abc123def456",
      "name": "Providence Fire Dispatch",
      "description": "System: rhode-island | Category: Fire Dispatch...",
      "audio_url": "https://cdn.openmhz.com/rhode-island/...",
      "wallet": {
        "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb5",
        "mode": "simple"
      },
      "active_listeners": 2
    }
  ]
}
```

### GET /api/streams/:systemId
Returns streams for a specific system (e.g., "rhode-island").

### GET /api/stream/:streamId
Returns details for a specific stream.

### GET /api/systems
Returns the list of available systems.

### POST /api/listen/start
Start tracking a listener for a stream.

**Request Body:**
```json
{
  "streamId": "rhode-island-3344-abc123def456",
  "listenerId": "web-client"
}
```

### POST /api/listen/stop
Stop tracking a listener for a stream.

**Request Body:**
```json
{
  "streamId": "rhode-island-3344-abc123def456",
  "listenerId": "web-client"
}
```

### GET /health
Health check endpoint.

## Frontend Features

### Streams Page (`/streams`)

The streams page provides:

1. **Stream Cards** - Each stream is displayed in a card with:
   - Stream name and category badge
   - Description with system info and duration
   - Active listener count
   - Wallet address display (using Scaffold-ETH Address component)
   - Play/Stop button

2. **Audio Playback** - Clicking "Listen" will:
   - Load the audio from the OpenMHz CDN URL
   - Call `/api/listen/start` to begin tracking
   - Play the audio in the browser
   - Show the stream as active (with a ring highlight)

3. **Listener Tracking** - When playing:
   - The backend tracks active listeners
   - The count is displayed on the stream card
   - Stopping or ending the audio calls `/api/listen/stop`

4. **Auto-refresh** - The stream list refreshes every 30 seconds to show the latest data.

### Home Page Updates

The main landing page now includes a new "Radio Streams" card that links to `/streams`.

## Data Flow

### When a User Clicks "Listen"

1. Frontend calls `handlePlay(stream)`
2. Creates HTML5 Audio element with `stream.audio_url`
3. Sends POST to `/api/listen/start` with `streamId`
4. Backend increments listener count
5. Audio plays from OpenMHz CDN
6. Frontend shows stream as active

### When Audio Stops

1. Frontend calls `handleStop(streamId)`
2. Pauses and cleans up Audio element
3. Sends POST to `/api/listen/stop` with `streamId`
4. Backend decrements listener count
5. Frontend removes active highlight

## File Structure

```
Argus-Defense/
├── backend/
│   ├── apiServer.js                         # Express API server for REST endpoints
│   ├── package.json                         # Updated with express, cors
│   ├── openmhz/
│   │   ├── example_streams_with_wallets.json # Generated stream data
│   │   ├── ingest_openmhz.py                # Python script to fetch OpenMHz data
│   │   └── streamServer_openmhz.js          # WebSocket server (merged, simplified)
│   └── sdr/
│       └── sim-capture.py                   # Local SDR simulation
└── frontend/nextjs/
    └── app/
        ├── page.tsx                         # Updated with streams link
        └── streams/
            └── page.tsx                     # Streams UI page
```

## Testing

### 1. Test the API Server

```bash
# Check health
curl http://localhost:3001/health

# Get all streams
curl http://localhost:3001/api/streams

# Get streams for a specific system
curl http://localhost:3001/api/streams/rhode-island

# Start listening (increment count)
curl -X POST http://localhost:3001/api/listen/start \
  -H "Content-Type: application/json" \
  -d '{"streamId":"rhode-island-3344-abc123def456"}'

# Stop listening (decrement count)
curl -X POST http://localhost:3001/api/listen/stop \
  -H "Content-Type: application/json" \
  -d '{"streamId":"rhode-island-3344-abc123def456"}'
```

### 2. Test the Frontend

1. Navigate to `http://localhost:3000`
2. Click on "Radio Streams" card
3. You should see the list of streams
4. Click "Listen" on any stream
5. Audio should play from OpenMHz
6. The stream card should highlight
7. Click "Stop" to stop playback

## Troubleshooting

### "Failed to fetch" Error on Streams Page

**Error:** Frontend shows "Error: Failed to fetch streams"

This means the frontend cannot connect to the API server. Check:

1. **Is the API server running?**
   ```bash
   # In a separate terminal, from project root
   yarn api
   ```
   You should see: `🚀 Argus Defense API Server running on http://localhost:3001`

2. **Test the API directly:**
   ```bash
   curl http://localhost:3001/health
   ```
   Should return: `{"status":"ok","timestamp":"...","active_streams":0}`

3. **Check the browser console:**
   - Open DevTools (F12 or Cmd+Option+I)
   - Look for CORS errors or connection refused messages
   - The error will tell you if it's trying to connect to the right URL

4. **Verify environment variable:**
   - Check that `frontend/nextjs/.env.local` exists
   - Should contain: `NEXT_PUBLIC_API_URL=http://localhost:3001`
   - **Restart the frontend** after creating/changing .env files (NextJS caches env vars)

5. **Port conflict:**
   - Make sure nothing else is using port 3001
   - Check with: `lsof -i :3001`

### API Server Won't Start

**Error:** `Cannot find module 'express'` or workspace errors
- **Solution:** Run `yarn install` from the project root (not the Backend directory)
- This project uses Yarn workspaces, so install from root

### Frontend Can't Connect to API

**Error:** CORS errors or connection refused
- **Solution:** Make sure the API server is running on port 3001
- **Solution:** Check that `NEXT_PUBLIC_API_URL` is set correctly

### No Streams Showing

**Error:** "No streams available"
- **Solution:** Run `python3 backend/sdr/ingest_openmhz.py` to generate stream data
- **Solution:** Check that `Assets/example_streams_with_wallets.json` exists

### Audio Won't Play

**Error:** Audio element fails to play
- **Solution:** Check browser console for CORS errors
- **Solution:** Verify the `audio_url` is accessible from OpenMHz CDN
- **Solution:** Some browsers require user interaction before playing audio

### Wallet Addresses Not Showing

**Error:** Wallet address is undefined
- **Solution:** Regenerate stream data with `ingest_openmhz.py`
- **Solution:** Ensure the stream data includes `wallet` objects

## Next Steps

### Implement Reward Distribution

The streams now have associated wallet addresses. The next step would be to:

1. Create smart contracts for reward distribution
2. Track listen time on-chain
3. Distribute rewards based on listener engagement
4. Show reward statistics on the frontend

### Enhance the UI

Additional features to consider:

1. Filter streams by category/system
2. Search functionality
3. Favorite streams (save to localStorage)
4. Listen history
5. Real-time listener count updates (WebSocket)
6. Waveform visualization
7. Share stream links

### Add Authentication

For production:

1. User authentication (wallet-based)
2. Associate listeners with wallet addresses
3. Track individual listening history
4. Enable claiming rewards

## Summary

✅ **Step 6 Complete:** Backend API server exposes stream data at `/api/streams`
✅ **Step 7 Complete:** Frontend displays streams with wallet addresses and audio playback

The system now provides:
- REST API serving OpenMHz stream data
- Stream cards with metadata and wallet addresses
- HTML5 audio playback from OpenMHz CDN
- Active listener tracking
- Integration with Scaffold-ETH UI components

Users can now discover emergency radio streams, see the associated wallet addresses for rewards, and listen to live communications directly in the browser.
